#!/usr/bin/env bash
set -euo pipefail

# ======================================================
# ArgoTunnel + VMess/VLESS ä¸€é”®å®‰è£…è„šæœ¬ (Alpine)
# ======================================================

die(){ echo "âœ– $*" >&2; exit 1; }
info(){ echo "â†’ $*"; }

IS_ROOT=false
[ "$(id -u)" -eq 0 ] && IS_ROOT=true

# é¢œè‰²
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[1;33m'
cyan='\033[1;36m'
bold='\033[1m'
re='\033[0m'

clear
echo -e "${cyan}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ðŸš€ VMess/VLESS + Argo Tunnel å®‰è£…å™¨     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${re}"

# ===============================================================
# èœå•
# ===============================================================
echo -e "${bold}${green}1) ç”ŸæˆèŠ‚ç‚¹ + Argo Tunnel${re}"
echo -e "${bold}${red}2) å¸è½½ Argo Tunnel${re}"
echo -e "${bold}${yellow}3) é€€å‡º${re}"

while true; do
  read -r -p "$(echo -e "${yellow}â†’ è¯·é€‰æ‹©æ“ä½œ (1/2/3): ${re}")" ACTION
  case "$ACTION" in
    1) break ;;
    2) ACTION="uninstall"; break ;;
    3) exit 0 ;;
    *) echo -e "${red}âœ– æ— æ•ˆé€‰æ‹©${re}" ;;
  esac
done

# ===============================================================
# å¸è½½é€»è¾‘
# ===============================================================
if [ "$ACTION" = "uninstall" ]; then
  echo "âš ï¸ å¸è½½ Argo Tunnel..."
  if $IS_ROOT; then
    SERVICE_FILE="/etc/systemd/system/cloudflared.service"
    CRED_DIR="/root/.cloudflared"
    BIN_PATH="/usr/local/bin/cloudflared"
    systemctl disable --now cloudflared 2>/dev/null || true
    rm -f "$SERVICE_FILE"
    systemctl daemon-reload || true
  else
    SERVICE_FILE="$HOME/.config/systemd/user/cloudflared.service"
    CRED_DIR="$HOME/.cloudflared"
    BIN_PATH="$HOME/.local/bin/cloudflared"
    systemctl --user disable --now cloudflared 2>/dev/null || true
    rm -f "$SERVICE_FILE"
    systemctl --user daemon-reload || true
  fi
  rm -rf "$CRED_DIR" "$BIN_PATH"
  info "âœ… å·²å¸è½½ Argo Tunnel"
  exit 0
fi

# ===============================================================
# å®‰è£…å¿…è¦å·¥å…·
# ===============================================================
info "æ£€æµ‹ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·..."
if [ -f /etc/alpine-release ]; then
  apk add --no-cache curl wget bash coreutils || true
elif [ -f /etc/debian_version ]; then
  apt update -y && apt install -y curl wget bash coreutils || true
elif [ -f /etc/redhat-release ]; then
  yum install -y curl wget bash coreutils || true
else
  die "ä¸æ”¯æŒçš„ç³»ç»Ÿç±»åž‹"
fi

# ===============================================================
# ç”Ÿæˆ VMess/VLESS èŠ‚ç‚¹
# ===============================================================
echo "=== ç”Ÿæˆ VMess/VLESS èŠ‚ç‚¹ ==="
while true; do
  echo "é€‰æ‹©åè®®: 1) VMess 2) VLESS"
  read -r -p "é€‰æ‹© (é»˜è®¤ 1): " PROT
  PROT=${PROT:-1}
  [[ "$PROT" =~ ^[12]$ ]] && break
done
PROT_NAME=$([ "$PROT" = 1 ] && echo "vmess" || echo "vless")

read -r -p "è¯·è¾“å…¥èŠ‚ç‚¹æœ¬åœ°ç›‘å¬ç«¯å£ (é»˜è®¤ 443): " NODE_PORT
NODE_PORT=${NODE_PORT:-443}
read -r -p "WebSocket è·¯å¾„ (é»˜è®¤ /): " WS_PATH
WS_PATH=${WS_PATH:-/}
[[ "$WS_PATH" != /* ]] && WS_PATH="/$WS_PATH"
UUID=$(cat /proc/sys/kernel/random/uuid)

echo
info "ç”ŸæˆèŠ‚ç‚¹é…ç½®:"
echo "åè®®: $PROT_NAME"
echo "ç«¯å£: $NODE_PORT"
echo "WSè·¯å¾„: $WS_PATH"
echo "UUID: $UUID"

# ===============================================================
# Argo Tunnel æ˜ å°„é…ç½®
# ===============================================================
read -r -p "è¯·è¾“å…¥ç»‘å®šçš„åŸŸå (Public Hostname): " DOMAIN
read -r -p "åè®®ç±»åž‹ (http/https/tcp é»˜è®¤ http): " PROTO
PROTO=${PROTO:-http}
echo "é€‰æ‹©ä¼ è¾“æ–¹å¼: 1) WebSocket 2) gRPC 3) TCP"
read -r -p "é€‰æ‹© (é»˜è®¤ 1): " STREAM
STREAM=${STREAM:-1}
case "$STREAM" in
  1) STREAM_TYPE="ws" ;;
  2) STREAM_TYPE="grpc" ;;
  3) STREAM_TYPE="tcp" ;;
  *) STREAM_TYPE="ws" ;;
esac

# ===============================================================
# å®‰è£… cloudflared
# ===============================================================
ARCH=$(uname -m)
case "$ARCH" in
  x86_64|amd64) FILE="cloudflared-linux-amd64" ;;
  aarch64|arm64) FILE="cloudflared-linux-arm64" ;;
  *) die "ä¸æ”¯æŒçš„æž¶æž„: $ARCH" ;;
esac

DEST="$([ "$IS_ROOT" = true ] && echo "/usr/local/bin" || echo "$HOME/.local/bin")"
mkdir -p "$DEST"
wget -q -O "${DEST}/cloudflared" "https://github.com/cloudflare/cloudflared/releases/latest/download/${FILE}" || die "ä¸‹è½½ cloudflared å¤±è´¥"
chmod +x "${DEST}/cloudflared"
info "âœ… cloudflared å®‰è£…å®Œæˆ"

CLOUD_BIN="${DEST}/cloudflared"
CRED_DIR="$([ "$IS_ROOT" = true ] && echo "/root/.cloudflared" || echo "$HOME/.cloudflared")"
CONFIG_FILE="$CRED_DIR/config.yml"
TOKEN_FILE="$CRED_DIR/token"
mkdir -p "$CRED_DIR"
chmod 700 "$CRED_DIR"

while true; do
  read -r -p "è¯·è¾“å…¥ Cloudflare Tunnel Token (eyJå¼€å¤´): " TUNNEL_TOKEN
  [[ -n "$TUNNEL_TOKEN" ]] && break || echo -e "${red}Tokenä¸èƒ½ä¸ºç©º${re}"
done
printf "%s" "$TUNNEL_TOKEN" > "$TOKEN_FILE"
chmod 600 "$TOKEN_FILE"

# ===============================================================
# ç”Ÿæˆ config.yml
# ===============================================================
info "ç”Ÿæˆ Argo Tunnel é…ç½®æ–‡ä»¶ $CONFIG_FILE"
{
  echo "ingress:"
  case "$PROTO" in
    tcp) SERVICE="tcp://localhost:${NODE_PORT}" ;;
    http) SERVICE="http://localhost:${NODE_PORT}" ;;
    https) SERVICE="https://localhost:${NODE_PORT}" ;;
    *) SERVICE="http://localhost:${NODE_PORT}" ;;
  esac
  echo "  - hostname: ${DOMAIN}"
  echo "    service: ${SERVICE}"
  echo "    originRequest:"
  echo "      noTLSVerify: true"
  echo "      httpHostHeader: ${DOMAIN}"
  if [ "$STREAM_TYPE" = "ws" ] && { [ "$PROTO" = "http" ] || [ "$PROTO" = "https" ]; }; then
    echo "      headers:"
    echo "        Connection: Upgrade"
    echo "        Upgrade: websocket"
  fi
  echo "  - service: http_status:404"
} > "$CONFIG_FILE"
chmod 600 "$CONFIG_FILE"

# ===============================================================
# systemd æœåŠ¡
# ===============================================================
EXEC_CMD="$CLOUD_BIN tunnel run --token-file ${TOKEN_FILE}"

if $IS_ROOT; then
  SERVICE_FILE="/etc/systemd/system/cloudflared.service"
  cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Cloudflare Tunnel
After=network-online.target
[Service]
Type=simple
ExecStart=${EXEC_CMD}
Restart=on-failure
RestartSec=5s
User=root
WorkingDirectory=${CRED_DIR}
[Install]
WantedBy=multi-user.target
EOF
  systemctl daemon-reload
  systemctl enable --now cloudflared
else
  USER_SERVICE_DIR="${HOME}/.config/systemd/user"
  mkdir -p "$USER_SERVICE_DIR"
  SERVICE_FILE="${USER_SERVICE_DIR}/cloudflared.service"
  cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Cloudflare Tunnel (user)
After=network-online.target
[Service]
Type=simple
ExecStart=${EXEC_CMD}
Restart=on-failure
RestartSec=5s
WorkingDirectory=${CRED_DIR}
[Install]
WantedBy=default.target
EOF
  systemctl --user daemon-reload
  systemctl --user enable --now cloudflared
fi

# ===============================================================
# è¾“å‡ºèŠ‚ç‚¹é“¾æŽ¥ä¿¡æ¯
# ===============================================================
echo
echo -e "${green}âœ… èŠ‚ç‚¹ + Argo Tunnel é…ç½®å®Œæˆ${re}"
echo
echo "èŠ‚ç‚¹ä¿¡æ¯:"
echo "  åè®®: $PROT_NAME"
echo "  åœ°å€: $DOMAIN"
echo "  ç«¯å£: $NODE_PORT"
echo "  UUID: $UUID"
echo "  WSè·¯å¾„: $WS_PATH"
echo
echo "Argo Tunnel:"
echo "  åŸŸå: $DOMAIN"
echo "  é…ç½®æ–‡ä»¶: $CONFIG_FILE"
echo

echo -e "${green}èŠ‚ç‚¹é“¾æŽ¥ä¿¡æ¯:${re}"
if [ "$PROT_NAME" = "vmess" ]; then
  VMESS_JSON=$(printf '{
    "v": "2",
    "ps": "Argo-VMess",
    "add": "%s",
    "port": "%s",
    "id": "%s",
    "aid": "0",
    "net": "ws",
    "type": "none",
    "host": "%s",
    "path": "%s",
    "tls": "tls"
  }' "$DOMAIN" "$NODE_PORT" "$UUID" "$DOMAIN" "$WS_PATH")
  VMESS_LINK=$(echo -n "$VMESS_JSON" | base64 -w0)
  echo "vmess://$VMESS_LINK"
else
  echo "vless://$UUID@$DOMAIN:$NODE_PORT?type=ws&security=tls&path=$WS_PATH#$DOMAIN"
fi

echo
echo "ðŸ“‹ æŸ¥çœ‹æ—¥å¿—: journalctl -u cloudflared -f"
echo "ðŸ”„ é‡å¯æœåŠ¡: systemctl restart cloudflared"