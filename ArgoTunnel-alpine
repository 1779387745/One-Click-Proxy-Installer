#!/bin/sh
set -eu

# =====================================================
# 非 root Alpine 2.0 容器版
# 自动生成 VMess/VLESS 节点 + Argo Tunnel + 快捷管理命令
# =====================================================

HOME=${HOME:-/root}
BIN_DIR="$HOME/.local/bin"
mkdir -p "$BIN_DIR" "$HOME/.cloudflared" "$HOME/.v2ray"

CLOUD_BIN="$BIN_DIR/cloudflared"
CONFIG_FILE="$HOME/.cloudflared/config.yml"
TOKEN_FILE="$HOME/.cloudflared/token"
NODE_DIR="$HOME/.v2ray"

die(){ echo "✖ $*" >&2; exit 1; }
info(){ echo "→ $*"; }

# ---------------------------
# 安装 cloudflared
# ---------------------------
install_cloudflared(){
  [ -x "$CLOUD_BIN" ] && return
  info "安装 cloudflared..."
  ARCH=$(uname -m)
  case "$ARCH" in
    x86_64) FILE="cloudflared-linux-amd64" ;;
    aarch64) FILE="cloudflared-linux-arm64" ;;
    *) die "不支持架构: $ARCH" ;;
  esac
  wget -q -O "$CLOUD_BIN" "https://github.com/cloudflare/cloudflared/releases/latest/download/$FILE"
  chmod +x "$CLOUD_BIN"
}

# ---------------------------
# 生成节点
# ---------------------------
generate_node(){
  PROT=${PROT:-vmess}
  DOMAIN=${DOMAIN:-example.com}
  WS_PATH=${WS_PATH:-/}
  TUNNEL_TOKEN=${TUNNEL_TOKEN:-""}
  NUM=${NUM:-1}

  [ -n "$TUNNEL_TOKEN" ] || die "请在环境变量 TUNNEL_TOKEN 设置 Cloudflare Tunnel Token"

  NODE_PORT=$((RANDOM % 10000 + 30000))
  UUID=$(cat /proc/sys/kernel/random/uuid)
  NODE_CONF="$NODE_DIR/$PROT-$NODE_PORT.json"
  mkdir -p "$NODE_DIR"

  # xray 节点配置
  cat > "$NODE_CONF" <<EOF
{
  "inbounds": [{
    "port": $NODE_PORT,
    "protocol": "$PROT",
    "settings": {"clients":[{"id":"$UUID","alterId":0}]},
    "streamSettings":{"network":"ws","wsSettings":{"path":"$WS_PATH"}}
  }]
}
EOF
  # Tunnel token
  printf "%s" "$TUNNEL_TOKEN" > "$TOKEN_FILE"
  chmod 600 "$TOKEN_FILE"

  # cloudflared 配置
  cat > "$CONFIG_FILE" <<EOF
ingress:
  - hostname: $DOMAIN
    service: tcp://127.0.0.1:$NODE_PORT
    originRequest:
      noTLSVerify: true
  - service: http_status:404
EOF

  info "节点生成完成: $NODE_CONF"
  info "Argo Tunnel 配置: $CONFIG_FILE"

  # 输出节点链接
  echo
  echo "================ 节点链接 ================="
  for i in $(seq 1 "$NUM"); do
    if [ "$PROT" = "vmess" ]; then
      VMESS_JSON=$(printf '{
        "v":"2","ps":"Argo-VMess",
        "add":"%s","port":"%s",
        "id":"%s","aid":"0",
        "net":"ws","type":"none",
        "host":"%s","path":"%s",
        "tls":"tls"}' "$DOMAIN" "$NODE_PORT" "$UUID" "$DOMAIN" "$WS_PATH")
      VMESS_LINK=$(echo -n "$VMESS_JSON" | base64 -w0)
      echo "vmess://$VMESS_LINK"
    else
      echo "vless://$UUID@$DOMAIN:$NODE_PORT?type=ws&security=tls&path=$WS_PATH#$DOMAIN"
    fi
  done
  echo "=========================================="
}

# ---------------------------
# 启动 cloudflared + xray
# ---------------------------
start_node(){
  install_cloudflared
  nohup "$CLOUD_BIN" tunnel --config "$CONFIG_FILE" run --token-file "$TOKEN_FILE" >/dev/null 2>&1 &
  sleep 2
  info "Cloudflared 已启动"
}

# ---------------------------
# 停止 cloudflared
# ---------------------------
stop_node(){
  pkill -f "$CLOUD_BIN" || true
  info "Cloudflared 已停止"
}

# ---------------------------
# 卸载节点
# ---------------------------
uninstall_node(){
  stop_node
  rm -rf "$NODE_DIR" "$HOME/.cloudflared" "$CLOUD_BIN"
  info "所有节点及 cloudflared 已卸载"
}

# ---------------------------
# 查看节点链接
# ---------------------------
show_links(){
  for NODE_FILE in "$NODE_DIR"/*.json; do
    [ -f "$NODE_FILE" ] || continue
    UUID=$(jq -r '.inbounds[0].settings.clients[0].id' "$NODE_FILE")
    PORT=$(jq -r '.inbounds[0].port' "$NODE_FILE")
    PROT=$(jq -r '.inbounds[0].protocol' "$NODE_FILE")
    if [ "$PROT" = "vmess" ]; then
      VMESS_JSON=$(printf '{
        "v":"2","ps":"Argo-VMess",
        "add":"%s","port":"%s",
        "id":"%s","aid":"0",
        "net":"ws","type":"none",
        "host":"%s","path":"%s",
        "tls":"tls"}' "$DOMAIN" "$PORT" "$UUID" "$DOMAIN" "$WS_PATH")
      VMESS_LINK=$(echo -n "$VMESS_JSON" | base64 -w0)
      echo "vmess://$VMESS_LINK"
    else
      echo "vless://$UUID@$DOMAIN:$PORT?type=ws&security=tls&path=$WS_PATH#$DOMAIN"
    fi
  done
}

# ---------------------------
# 主逻辑（快捷命令接口）
# ---------------------------
case "${1:-}" in
  gen)      generate_node ;;
  start)    start_node ;;
  stop)     stop_node ;;
  restart)  stop_node; start_node ;;
  links)    show_links ;;
  uninstall)uninstall_node ;;
  *) echo "用法: ss [gen|start|stop|restart|links|uninstall]" ;;
esac