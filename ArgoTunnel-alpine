#!/bin/sh
# =========================================================
# 一键运行 Xray + Argo Tunnel 终极脚本（修正版 WS=/）
# VLESS + VMess | WS=/ | TLS | Alpine / 非 root / 容器可用
# =========================================================

set -e

BASE="$HOME/xray"
BIN="$BASE/xray"
CONF="$BASE/config.json"
PID="$BASE/xray.pid"
INFO="$BASE/nodes.txt"
CF="$BASE/cloudflared"
ARGO="$BASE/argo"
WS_PATH="/"  # 统一改成 /

mkdir -p "$BASE" "$ARGO"
touch "$INFO"

# ---------- 依赖 ----------
for cmd in jq wget unzip; do
  command -v "$cmd" >/dev/null 2>&1 || {
    echo "[-] 缺少依赖: $cmd"
    echo "    Alpine: apk add jq wget unzip"
    exit 1
  }
done

# ---------- 下载 Xray ----------
if [ ! -x "$BIN" ]; then
  echo "[+] 下载 Xray core..."
  wget -qO "$BASE/xray.zip" \
    https://github.com/XTLS/Xray-core/releases/download/v25.12.8/Xray-linux-64.zip
  unzip -qo "$BASE/xray.zip" -d "$BASE"
  chmod +x "$BIN"
fi

# ---------- 下载 cloudflared ----------
if [ ! -x "$CF" ]; then
  echo "[+] 下载 cloudflared..."
  wget -qO "$CF" \
    https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
  chmod +x "$CF"
fi

# ---------- 初始化 Xray 配置 ----------
if [ ! -f "$CONF" ]; then
  cat >"$CONF" <<EOF
{
  "inbounds": [
    {
      "listen": "127.0.0.1",
      "port": 10000,
      "protocol": "vless",
      "settings": {
        "clients": [],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": { "path": "$WS_PATH" }
      }
    }
  ],
  "outbounds": [{ "protocol": "freedom" }]
}
EOF
fi

uuid() { cat /proc/sys/kernel/random/uuid; }

# ---------- 启动 Xray ----------
start_xray() {
  "$BIN" run -config "$CONF" >/dev/null 2>&1 &
  echo $! >"$PID"
}

stop_xray() {
  [ -f "$PID" ] && kill "$(cat "$PID")" 2>/dev/null || true
}

# ---------- 生成节点 ----------
generate_node() {
  VLESS_ID=$(uuid)
  VMESS_ID=$(uuid)

  jq ".inbounds[0].settings.clients += [
    {\"id\":\"$VLESS_ID\"},
    {\"id\":\"$VMESS_ID\",\"alterId\":0}
  ]" "$CONF" >"$CONF.tmp" && mv "$CONF.tmp" "$CONF"

  DOMAIN=$(cat "$ARGO/domain")

  VLESS="vless://$VLESS_ID@$DOMAIN:443?encryption=none&security=tls&type=ws&path=$WS_PATH#VLESS-Argo"
  VMESS_JSON=$(printf '{"v":"2","ps":"VMess-Argo","add":"%s","port":"443","id":"%s","aid":"0","net":"ws","path":"%s","tls":"tls"}' \
    "$DOMAIN" "$VMESS_ID" "$WS_PATH")
  VMESS="vmess://$(echo "$VMESS_JSON" | base64 | tr -d '\n')"

  echo "$VLESS" >"$INFO"
  echo "$VMESS" >>"$INFO"

  echo "[+] 节点生成完成，可直接导入客户端"
  echo "$VLESS"
  echo "$VMESS"
}

# ---------- Argo Tunnel ----------
start_argo() {
  echo "请选择 Argo Tunnel 类型："
  echo "1) 临时隧道 (Quick Tunnel)"
  echo "2) 固定隧道 (Named Tunnel)"
  read choice </dev/tty

  if [ "$choice" = "1" ]; then
    echo "[+] 启动 Quick Tunnel..."
    "$CF" tunnel --url http://127.0.0.1:10000 >"$ARGO/log" 2>&1 &
    sleep 5
    DOMAIN=$(grep -oE 'https://[a-z0-9\-]+\.trycloudflare.com' "$ARGO/log" | head -n1 | sed 's#https://##')
    echo "$DOMAIN" >"$ARGO/domain"
  else
    echo "[+] 启动 Named Tunnel..."
    "$CF" login
    echo "请输入要绑定的域名:"
    read DOMAIN </dev/tty
    "$CF" tunnel create xray
    cat >"$ARGO/config.yml" <<EOF
tunnel: xray
credentials-file: $HOME/.cloudflared/*.json
ingress:
  - hostname: $DOMAIN
    service: http://127.0.0.1:10000
  - service: http_status:404
EOF
    "$CF" tunnel run xray >/dev/null 2>&1 &
    echo "$DOMAIN" >"$ARGO/domain"
  fi
}

# ---------- 主流程 ----------
echo "[+] 启动 Xray..."
start_xray
echo "[+] 启动 Argo Tunnel..."
start_argo
echo "[+] 生成节点..."
generate_node

echo
echo "========================="
echo "节点已生成并可用"
echo "WS Path: $WS_PATH (已统一为 /)"
echo "========================="