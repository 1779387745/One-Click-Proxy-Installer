#!/bin/sh
# =========================================================
# Xray + Argo Tunnel 终极稳定版（Quick / Named 可选）
# VLESS + VMess | WS + TLS | Alpine / 非 root
# =========================================================

set -e

BASE="$HOME/xray"
BIN="$BASE/xray"
CONF="$BASE/config.json"
PID="$BASE/xray.pid"
INFO="$BASE/nodes.txt"
CF="$BASE/cloudflared"
ARGO="$BASE/argo"
WS_PATH="/ws/api/v1"

mkdir -p "$BASE"
touch "$INFO"

# ---------- 依赖 ----------
for c in jq wget unzip; do
  command -v "$c" >/dev/null 2>&1 || {
    echo "[-] 缺少依赖: $c"
    exit 1
  }
done

# ---------- Xray ----------
if [ ! -x "$BIN" ]; then
  wget -qO "$BASE/xray.zip" \
    https://github.com/XTLS/Xray-core/releases/download/v25.12.8/Xray-linux-64.zip
  unzip -qo "$BASE/xray.zip" -d "$BASE"
  chmod +x "$BIN"
fi

# ---------- cloudflared ----------
if [ ! -x "$CF" ]; then
  wget -qO "$CF" \
    https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
  chmod +x "$CF"
fi

# ---------- init config ----------
cat >"$CONF" <<EOF
{
  "inbounds": [
    {
      "listen": "127.0.0.1",
      "port": 10000,
      "protocol": "vless",
      "settings": {
        "clients": [],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": { "path": "$WS_PATH" }
      }
    }
  ],
  "outbounds": [{ "protocol": "freedom" }]
}
EOF

uuid() { cat /proc/sys/kernel/random/uuid; }

# ---------- 启动 Xray ----------
start_xray() {
  "$BIN" run -config "$CONF" >/dev/null 2>&1 &
  echo $! >"$PID"
}

stop_xray() {
  [ -f "$PID" ] && kill "$(cat "$PID")" 2>/dev/null || true
}

# ---------- 生成节点 ----------
generate_node() {
  VLESS_ID=$(uuid)
  VMESS_ID=$(uuid)

  jq ".inbounds[0].settings.clients += [
    {\"id\":\"$VLESS_ID\"},
    {\"id\":\"$VMESS_ID\",\"alterId\":0}
  ]" "$CONF" >"$CONF.tmp" && mv "$CONF.tmp" "$CONF"

  DOMAIN=$(cat "$ARGO/domain")

  VLESS="vless://$VLESS_ID@$DOMAIN:443?encryption=none&security=tls&type=ws&path=$WS_PATH#VLESS-Argo"
  VMESS_JSON=$(printf '{"v":"2","ps":"VMess-Argo","add":"%s","port":"443","id":"%s","aid":"0","net":"ws","path":"%s","tls":"tls"}' \
    "$DOMAIN" "$VMESS_ID" "$WS_PATH")
  VMESS="vmess://$(echo "$VMESS_JSON" | base64 | tr -d '\n')"

  echo "$VLESS" >>"$INFO"
  echo "$VMESS" >>"$INFO"

  echo "[+] 节点已生成，可直接连接"
  echo "$VLESS"
  echo "$VMESS"
}

# ---------- Argo ----------
start_argo() {
  echo "1) 临时隧道 (Quick Tunnel)"
  echo "2) 固定隧道 (Named Tunnel)"
  read m </dev/tty

  if [ "$m" = "1" ]; then
    "$CF" tunnel --url http://127.0.0.1:10000 >"$ARGO.log" 2>&1 &
    sleep 5
    DOMAIN=$(grep -oE 'https://[a-z0-9\-]+\.trycloudflare.com' "$ARGO.log" | head -n1 | sed 's#https://##')
    echo "$DOMAIN" >"$ARGO/domain"
  else
    "$CF" login
    echo "输入绑定域名:"
    read DOMAIN </dev/tty
    "$CF" tunnel create xray
    cat >"$ARGO/config.yml" <<EOF
tunnel: xray
credentials-file: $HOME/.cloudflared/*.json
ingress:
  - hostname: $DOMAIN
    service: http://127.0.0.1:10000
  - service: http_status:404
EOF
    "$CF" tunnel run xray >/dev/null 2>&1 &
    echo "$DOMAIN" >"$ARGO/domain"
  fi
}

# ---------- 主流程 ----------
start_xray
start_argo
generate_node

echo
echo "========================="
echo "节点已生成并可用"
echo "WS Path: $WS_PATH"
echo "========================="